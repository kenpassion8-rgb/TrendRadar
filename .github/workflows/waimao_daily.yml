name: 外贸日报自动推送

on:
  schedule:
    # 每天北京时间 08:00 运行（UTC+8，所以 UTC 是 00:00）
    - cron: '0 0 * * *'
  workflow_dispatch:  # 允许手动触发，方便测试

jobs:
  send-daily-report:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      # ─────────────────────────────────────
      # 1. 拉取代码
      # ─────────────────────────────────────
      - name: 检出仓库代码
        uses: actions/checkout@v4

      # ─────────────────────────────────────
      # 2. 安装 Python 环境
      # ─────────────────────────────────────
      - name: 安装 Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: 安装 Python 依赖
        run: |
          pip install requests

      # ─────────────────────────────────────
      # 3. 安装 Node.js（生成海报图片用）
      # ─────────────────────────────────────
      - name: 安装 Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: 安装 Playwright
        run: |
          npm install -g playwright
          npx playwright install chromium --with-deps

      # ─────────────────────────────────────
      # 4. 运行 TrendRadar 抓取外贸新闻
      # ─────────────────────────────────────
      - name: 运行 TrendRadar 抓取新闻
        run: |
          pip install -r requirements.txt 2>/dev/null || true
          python trendradar/main.py --output output/latest.json 2>/dev/null || python main.py --output output/latest.json 2>/dev/null || echo "TrendRadar 运行完成"
        env:
          WEWORK_WEBHOOK_URL: ${{ secrets.WEWORK_WEBHOOK_URL }}
          WEWORK_MSG_TYPE: ${{ secrets.WEWORK_MSG_TYPE }}
        continue-on-error: true

      # ─────────────────────────────────────
      # 5. 生成海报 + 发送到企业微信
      # ─────────────────────────────────────
      - name: 生成海报并发送
        run: |
          python scripts/poster_and_send.py
        env:
          KIMI_API_KEY: ${{ secrets.KIMI_API_KEY }}
          WEWORK_WEBHOOK_URL: ${{ secrets.WEWORK_WEBHOOK_URL }}
          WECOM_CORP_ID: ${{ secrets.WECOM_CORP_ID }}
          WECOM_AGENT_ID: ${{ secrets.WECOM_AGENT_ID }}
          WECOM_APP_SECRET: ${{ secrets.WECOM_APP_SECRET }}
